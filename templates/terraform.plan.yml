parameters:
- name: workingDirectory
  type: string
- name: variablesFile
  type: string
  default: ''
- name: variables
  type: string
  default: ''
# Azure Backend
- name: backendConfigFile
  type: string
  default: ''
- name: azureSubscription
  type: string
  default: ''
- name: stateResourceGroup
  type: string
  default: ''
- name: stateStorageAccount
  type: string
  default: ''
- name: stateStorageAccountContainer
  type: string
  default: ''
- name: stateStorageAccountKey
  type: string
  default: ''

steps:
- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
  displayName: Download Terraform

- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
  displayName: Initializing
  inputs:
    command: init
    workingDirectory: ${{ parameters.workingDirectory }}
    backendType: azurerm
    backendServiceArm: ${{ parameters.azureSubscription }}
    backendAzureRmResourceGroupName: ${{ parameters.stateResourceGroup }}
    backendAzureRmStorageAccountName: ${{ parameters.stateStorageAccount }}
    backendAzureRmContainerName: ${{ parameters.stateStorageAccountContainer }}
    backendAzureRmKey: ${{ parameters.stateStorageAccountKey }}
  env:
    TF_CLI_ARGS: -no-color
    TF_CLI_ARGS_init: -backend=${{ gt(length(parameters.azureSubscription), 0) }}
    TF_INPUT: false
    TF_CLI_CONFIG_FILE: ${{ parameters.backendConfigFile }}

- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
  displayName: Planning Infrastructure Change
  inputs:
    command: plan
    commandOptions: ${{ parameters.variables }}
    secureFilePath: ${{ parameters.variablesFile }}
    workingDirectory: ${{ parameters.workingDirectory }}
    environmentServiceName: ${{ parameters.azureSubscription }}
  env:
    TF_IN_AUTOMATATION: true
    TF_INPUT: false
